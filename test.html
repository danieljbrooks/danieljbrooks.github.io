<!DOCTYPE html>
<html lang="en">
<head>

<!-- css style sheet -->  
<link rel="stylesheet" type="text/css" href="draftsim.css">

<!-- google analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-56289140-3', 'auto');
  ga('send', 'pageview');
</script>

</head>

<body>

<!-- Include DTK cardlist -->
<script src="DTK.js"></script>
<script src="ORI.js"></script>

<!-- Clear the screen  -->
<script> function clear_screen(){
  var display_element = document.getElementsByClassName('display'), i;
  for (i = 0; i < display_element.length; i += 1) {
      display_element[i].style.visibility = 'hidden';
  }
}
</script>

<!-- Show the screen  -->
<script> function show_screen(){
  var display_element = document.getElementsByClassName('display'), i;
  for (i = 0; i < display_element.length; i += 1) {
      display_element[i].style.visibility = 'visible';
  }
}
</script>

<!-- Initialize -->
<script>var draft = "..."; </script>
<script> var pack_size=14; </script>

<script>function Pack(card_list){
  this.pack_contents=[];
  
  //Define card contents
  var common=0;
  var uncommon=0;
  var rare=0;
  var mythic=0;
  
  //Determine number of cards in set
  var cards_in_set=card_list.length

  //figure out if mythic or rare
  mythic_roll=Math.floor((Math.random() * 121) + 1);
  if (mythic_roll>15){
    mythic=1;
  } else {
    rare=1;
  }
  
  //add cards without duplication
  var its=0; //prevent infinite loops
  while(this.pack_contents.length<pack_size && its<10000){
    its=its+1;
    
    //choose a random card in the current set
    var card_roll=Math.floor((Math.random() * cards_in_set));
    var new_card = card_list[card_roll];
    //Check if card in pack contents
    var card_in_pack=0;
    if (this.pack_contents.length>0){
      for (var i = 0; i < this.pack_contents.length; i++) {
        if ( new_card.name==this.pack_contents[i].name){
          card_in_pack=1;
        }
      }
    }
    
    //Determine card rarity and add new card to pack if possible, in rarity order
    rarity_nc=new_card.rarity
    if (card_in_pack<1){
      if (rarity_nc=="M" && mythic < 1){
      	this.pack_contents.push(card_list[card_roll]);
      	mythic=mythic+1; 
      } else if (rarity_nc=="R" && rare < 1 && mythic==1){
      	this.pack_contents.push(card_list[card_roll]);
      	rare=rare+1;
      } else if (rarity_nc=="U" && uncommon < 3 && rare==1 && mythic==1){
      	this.pack_contents.push(card_list[card_roll]);
      	uncommon=uncommon+1;
      } else if (rarity_nc=="C" && common < pack_size-4 && uncommon==3){
      	this.pack_contents.push(card_list[card_roll]);
      	common=common+1;
      }
   }    
  }
}</script>

<script> function Draft(s1, s2, s3, num_players){
  
  //Create an array of players
  this.players=[];
  this.set1=s1;
  this.set2=s2;
  this.set3=s3;

  //Add players
  for (i = 0; i < num_players; i++) {
    var pack_i=new Pack(this.set1);
    var drafter_i= {pack:pack_i,collection:[],color_commit:[0,0,0,0,0],in_color:[0,0,0,0,0]};
    this.players.push(drafter_i);
  }
} </script>

<script> function update_in_color(p_index){ 
  
  //reset in_color
  draft.players[p_index].in_color=[0,0,0,0,0];

  //create temp_color_commit
  var temp_color_commit=[0,0,0,0,0];
  for (k=0;k<5;k++){
    temp_in_color[k]=draft.players[p_index].color_commit[k];
  }
  
  //find the maximum value
  max_index=0;
  max_value=temp_color_commit[0];
  for(k=1;k<5;k++){
    var cur_commit=temp_color_commit[k];
    if (cur_commit>max_value){
      max_index=k;
      max_value=cur_commit;
    }
  }
  if (max_value>0){
    draft.players[p_index].in_color[max_index]=1;    //mark max as in_color
    
    temp_in_color[max_index]=-10;     //don't repeat the maximum value
    
    //find the second_max value
    second_index=0;
    second_value=temp_color_commit[0];
    for(k=1;k<5;k++){
      var cur_commit=temp_color_commit[k];
      if (cur_commit>second_value){
        second_index=k;
        second_value=cur_commit;
      }
    }
   if (second_value>0){
     draft.players[p_index].in_color[second_index]=1; //mark second_max as in_color
   } 
  }
  return;
}</script>


<!-- always call this function before using this value -->
<script> function update_bias_pack(player_i){

  //update which cards on are color
  update_in_color(player_i);

  pack_length=draft.players[player_i].pack.pack_contents.length;

  //For each card in the pack
  for (i = 0; i < pack_length; i++) {

    var this_card=draft.players[player_i].pack.pack_contents[i];

    //get card's CMC (do this from python script
    //var cmc = this_card.cmc;
  
    //check if card is on color
    var on_color_card=1;
    var off_color_amount=0;
    for (xx=0; xx<5;xx++){
      if(this_card.colors[xx] > 0 && draft.players[player_i].in_color[xx]==0){
        on_color_card=0;
        off_color_amount+=this_card.colors[xx];
      }
    }  

    var draft_frac = draft.players[player_i].collection.length / (3.0 * pack_size);
    var time_bias = .2 + 1.3*draft_frac;

    if(on_color_card){
      cur_bias=time_bias;
    } else {
      //cur_bias=-1.0*time_bias*(off_color_amount-1);
      cur_bias=0;
    }

    this_card.color_bias=cur_bias;
  }  

return;

}
</script>

<script> function Print_collection(){
 
 //update the biases FIRST
 update_bias_pack(0); //update bias for just the player, add bots later

  //print out the length of the player's collection
  var debug_element = document.getElementById('debug');
  debug_element.innerHTML=draft.players[0].in_color + "<br>" + draft.players[0].color_commit;

 //Clear images
 pack_length = draft.players[0].pack.pack_contents.length;
 document.getElementById("pack_images").innerHTML = "";
 
 //Set up the card images properly
 for (i = 0; i < pack_length; i++) {
   var cur_html = document.getElementById("pack_images").innerHTML;
   var extra_html = "<img src=" + draft.players[0].pack.pack_contents[i].image +  " id=card_" + i + " onclick=make_pick(" + i + ") />";
   document.getElementById("pack_images").innerHTML = cur_html + extra_html;
 }

// Find a <table> element with id="myTable":
var tablep = document.getElementById("pack_text");
tablep.innerHTML=""; //clear the table

//add the card data
 for (i = 0; i < pack_length; i++) {
   var row = tablep.insertRow(i);
   var cell1 = row.insertCell(0);
   var cell2 = row.insertCell(1);
   var cell3 = row.insertCell(2);   

   // Add some text to the new cells:
   var cur_card = draft.players[0].pack.pack_contents[i];
   cell1.innerHTML = cur_card.name;
   cell2.innerHTML = cur_card.myrating;
   if (cur_card.hasOwnProperty('color_bias')){
     cell3.innerHTML = cur_card.color_bias.toFixed(1);
    } else {
     cell3.innerHTML="none";
    }

 }
  // var cur_html = document.getElementById("pack_images").innerHTML;
  // var extra_html = "<img src=" + draft.players[0].pack.pack_contents[i].image +  " id=card_" + i + " onclick=make_pick(" + i + ") />";
  // document.getElementById("pack_images").innerHTML = cur_html + extra_html;


 //create the header text
 var header = tablep.createTHead();
 var row = header.insertRow(0);
 // Create an empty <tr> element and add it to the 1st position of the table:
 // Insert new cells (<td> elements) at the 1st and 2nd position of the "new" <tr> element:
 var head1 = row.insertCell(0);
 var head2 = row.insertCell(1);
 var head3 = row.insertCell(2)
 head1.innerHTML = "Name";
 head2.innerHTML = "Rating";
 head3.innerHTML = "Color Bias";

//just set the table to peas and stuff
//div.innerHTML="<table><tr><th>One</th><th>Two</th></tr><tr><td>Apples</td><td>Carrots</td></tr><tr><td>Oranges</td><td>Potato</td></tr><tr><td>Pears</td><td>Peas</td></tr></table>";

 //display the collection
 document.getElementById("collection_img").innerHTML="";
 collection_length=draft.players[0].collection.length
 for (i = 0; i < collection_length; i++) {
   var cur_card = draft.players[0].collection[i];
 
 //card images
 if (typeof cur_card != "undefined"){ //make sure card isn't undefined
   var img = document.createElement("img");
   img.src = cur_card.image;
   document.getElementById("collection_img").appendChild(img);
 }
 }
} </script>

<script>function make_pick(card_index){

//player picks
 pack_length=draft.players[0].pack.pack_contents.length
 if(card_index >= pack_length){
  return 0;
} else {
  
  //update color commitment
  for (i = 0; i < 5; i++) { 
    if(draft.players[0].pack.pack_contents[card_index].colors[i]>0){
      draft.players[0].color_commit[i]+=Math.max(0,draft.players[0].pack.pack_contents[card_index].myrating);
    }
  }
  
  //pick the card and remove it from the pack
  draft.players[0].collection.push(draft.players[0].pack.pack_contents[card_index]);
  draft.players[0].pack.pack_contents.splice(card_index,1);

//bots make picks
for (i = 1; i < 8; i++) { 
  bot_pick(i);
}

//now pass the remaining cards
var cards_picked = draft.players[0].collection.length
if (cards_picked <= pack_size-1){   //pass left
  pass_cards(+1);
} else if (cards_picked == pack_size) { //generate pack 2
 for (i = 0; i < 8; i++) { 
  var pack_2=new Pack(draft.set2);
  draft.players[i].pack=pack_2;
 }
} else if (cards_picked <= 2*pack_size-1) {  //pass right
  pass_cards(-1);
} else if (cards_picked == 2 * pack_size) {   //generate pack 3
 for (i = 0; i < 8; i++) { 
  var pack_3=new Pack(draft.set3);
  draft.players[i].pack=pack_3;
 }
} else if (cards_picked <= 3*pack_size-1) { //pass left
  pass_cards(+1);
} else if (cards_picked == 3*pack_size) { //end draft
  //end draft
}

//Go to the next pick
Print_collection();

}}</script>

<!-- Pass cards to left or right (+1,-1) -->
<script> function pass_cards(pass_amount){
  var tmp_packs=['1', '2', '3', '4', '5', '6', '7', '8']; //dummy initialization
  
  //don't pass for now
  
  //put cards in tmp_packs
  for (i=0; i<8; i++){
   var p_index = ((i+pass_amount)+ 8) % 8;
   tmp_packs[p_index] = draft.players[i].pack;
  }
  
  //return packs to the draft
  for (i=0; i<8; i++){
    draft.players[i].pack=tmp_packs[i];
  }
  
  }</script>

<script> function bot_pick(bot_index){
 
 //output to screen 
 var pack_length=draft.players[bot_index].pack.pack_contents.length
 
 //determine the highest rated card
 var best_rating=0;
 var best_index=0;
 for (var i = 0; i < pack_length; i++) { 
   var cur_rating = draft.players[bot_index].pack.pack_contents[i].myrating; //is this a number?
   if (cur_rating > best_rating){
    best_rating=cur_rating;
    best_index=i;
   }
 }
 
  //get the picked card
  var picked_card=draft.players[bot_index].pack.pack_contents[best_index];
  

  var debug2 = document.getElementById("debug2");
  debug2.innerHTML=""
  //update color commitment
  for (i = 0; i < 5; i++) { 
    if(picked_card.colors[i]>0){
      draft.players[bot_index].color_commit[i]+=Math.max(0,picked_card.myrating-2.0);
      debug2.innerHTML=debug2.innerHTML+" / " + Math.max(0,picked_card.myrating-2.0);
    }
  }

 //choose the card (does this propertly modify bot?)
  draft.players[bot_index].collection.push(draft.players[bot_index].pack.pack_contents[best_index]); //pick the card
  draft.players[bot_index].pack.pack_contents.splice(best_index,1); //remove from pack
 
}</script>

<script> function Draft_DTK(){
  draft = new Draft(DTK, DTK, DTK, 8);
  Print_collection();
} </script>

<script> function Draft_ORI(){
  draft = new Draft(ORI, ORI, ORI, 8);
  Print_collection();
} </script>

<!-- HTML source code -->
<h1>draftsim.com</h1>
<h2>Magic: the Gathering draft and sealed simulation</h2>

<!-- Menu Bar  -->
<ul><li>draft
  <ul>
  <li onclick=Draft_DTK()>DTK</li>
  <li onclick=Draft_ORI()>ORI</li>
  </ul>
</li>

  <li>sealed</li>
</ul>

<br>

<!-- <p><a href="https://www.pythonanywhere.com/gists/905201f664f09b8a3b11/code.py/ipython2/">Draft Simulator (python version)!</a></p> --->
<!-- <p><button onclick= "Draft_DTK()" style="fontSize:xx-large;">Draft DTK-DTK-DTK</button>
<button onclick= "Draft_ORI()" style="fontSize:xx-large;">Draft ORI-ORI-ORI</button> </p> -->

<!--
<my_p id="pack_images" class="display" width="500"> </my_p>
<h2 id="pack_text" class="display"> </h2>
-->


<div id="pack_box" class="display">
   <my_p id="pack_images" class="display"> </my_p>
</div>

<div id="pack_text_container" class="display">
  <table id="pack_text" class="display">
  </table>
</div>
<br>
<p id="debug"> This is the debug box </p>
<p id="debug2"> This is the debug2 box </p>
<br>
<div id="collection_container" class="display">
  <p id="collection_img" class="display"> </p>
</div>
<br>

</body>
</html>
